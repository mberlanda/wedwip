var guestList = <%= @guests.to_json.html_safe %>;
var validationKey = "e5d272873508422db558acb2e76f1c281e7f76e41f58a024519272cdabce15e59ae6e1e0d1fa850951af51c18ce751d8782f71f24bc09458b2accc47705defbe";

$(document).ready(function() {
  renderGuestsTable();
});

$("#add-guest").click(function() {
  
  $("#error-input").html("");
  $("#success-input").html("");

  var name = $("#guest_name").val().trim().toLowerCase().capitalize(),
      surname = $("#guest_surname").val().trim().toLowerCase().capitalize(),
      validationCode = $("#guest_validation").val().trim().encrypt();
  
  if (validationCode != validationKey) {
    $("#error-input").html("Il codice di verifica inserito non è corretto");
    return;
  }

  if (name === "" || surname  === "") {
    $("#error-input").html("Tutti i campi devono essere compilati");
    return;
  }

  var item = {
    name: name,
    surname: surname
  };

  var found = false;
  $.each(guestList, function( index, value ) {
    if (value["name"] == name & value["surname"] == surname) {
      found = true;
    }
  });
  if (found) {
    $("#error-input").html("{name} {surname} è già stato inserito".supplant(item));
    return;
  }

  createGuest(item);
  
  $("#success-input").html("{name} {surname} è stato inserito con successo".supplant(item));
})

function createGuest(item){

  var request = $.ajax({
    beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
    url: '<%= guests_path %>',
    dataType: 'json',
    type: "POST",
    quietMillis: 200,
    data: { guest_json: JSON.stringify(item)}
    });

  request.done(function(data){
      if (data["status"] == "success"){
        console.log(data["guest_list"]);      
      }
      guestList = JSON.parse(data["guest_list"]);
      renderGuestsTable();
  });
}


function renderGuestsTable() {
  var template = $.templates("#added-guests-template");
  var htmlGuestList = template.render(guestList);
  $("#added-guests-container").html(htmlGuestList);  
}

function removeGuest(id_to_delete) {
  var request = $.ajax({
    beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
    url: '<%= guest_path(id: "id_to_delete") %>'.replace("id_to_delete", id_to_delete),
    type: "DELETE",
    quietMillis: 200
    });

  request.done(function(data){
    if (data["status"] == "success"){
      console.log(data["guest_list"]);      
    }
    guestList = JSON.parse(data["guest_list"]);
    renderGuestsTable();
  });
}
