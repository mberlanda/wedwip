var suggestionsList = <%= @suggestions.to_json.html_safe %>;

$(document).ready(function() {
  renderSuggestions();
});

$("#add-suggestion").click(function() {

  $("#error-suggestion").html("");
  $("#success-suggestion").html("");

  var name = $("#suggestion_name").val().trim().toLowerCase().capitalize(),
      title = $("#suggestion_title").val().trim(),
      message = $("#suggestion_message").val().trim();

  if (name === "" || title  === "" || message  === "" ) {
    $("#error-suggestion").html("Tutti i campi devono essere compilati!");
    return;
  }

  var item = {
    name: name,
    title: title,
    message: message
  };

  var found = false;
  $.each(suggestionsList, function( index, value ) {
    if (value["name"] == name & value["title"] == title & value["message"] == message) {
      found = true;
    }
  });
  if (found) {
    $("#error-suggestion").html("{name}: {title} è già stato inserito".supplant(item));
    return;
  }

  createSuggestion(item);
  $("#success-suggestion").html("Il tuo suggerimento è stato inserito.");

});


function createSuggestion(item){

  var request = $.ajax({
    beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
    url: '<%= trip_suggestions_path %>',
    dataType: 'json',
    type: "POST",
    quietMillis: 200,
    data: { suggestion_json: JSON.stringify(item)}
    });

  request.done(function(data){
      suggestionsList = JSON.parse(data["suggestion_json"]);
      renderSuggestions();
  });
}


function renderSuggestions() {
  var template = $.templates("#suggestion-template");
  var htmlSuggestionsList = template.render(suggestionsList);
  $("#suggestion-container").html(htmlSuggestionsList);
}
